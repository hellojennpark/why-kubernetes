---
description: etcd 에서 읽기/쓰기 작업 시의 내부 통신 흐름을 알아봅시다.
---

# etcd 읽고 쓰기

## 읽기

<figure><img src="../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

etcd는 두 가지 유형의 읽기를 지원합니다:

* **선형화 가능 읽기 (Linearizable Read)**:  **가장 강력한 일관성**을 제공하며, 클라이언트가 항상 **가장 최근에 커밋된 데이터**를 읽도록 보장합니다. 이를 위해 Raft 프로토콜을 통해 Leader의 상태를 검증하는 과정(Read Index)이 필요합니다.
* **직렬화 가능 읽기 (Serializable Read)**: **성능을 최적화**하기 위해 Raft 합의 과정을 생략합니다. 요청받은 개별 etcd 노드가 알고 있는 로컬 상태를 즉시 반환하며, 이는 **Stale Data (오래된 데이터)**&#xC77C; 가능성이 있습니다.

### 선형화 가능 읽기 (Linearizable Read)

| 단계                   | 요청 주체         | 대상 컴포넌트         | 역할 및 설명                                                                                                                          |
| -------------------- | ------------- | --------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| \[1] 요청 수신 및 \[2] 검증 | Client        | API Server      | 클라이언트 요청(`GET`)을 수신하고, Auth/Lease 컴포넌트를 통해 인증 및 권한을 확인합니다.                                                                       |
| \[3-1] Raft 리더십 검증   | API Server    | Raft Protocol   | `API Server`는 `Raft Protocol`에게 Read Index 요청을 보냅니다. 이는 현재 노드가 여전히 유효한 Leader이며, 자신이 알고 있는 데이터가 클러스터에서 최신 상태임을 보장하기 위한 합의 검증입니다. |
| \[3-2] 인덱스 검증        | Raft Protocol | Raft 노드들        | `Leader`는 `Follower`들에게 Heartbeat를 보내 자신의 Term과 Index를 확인하고, 과반수로부터 유효함을 응답받습니다. (데이터 복제는 발생하지 않으며, 상태 검증만 이루어집니다.)              |
| \[4] 데이터 인출          | API Server    | KV Store (MVCC) | `Raft Protocol`로부터 검증 완료 응답을 받으면, `API Server`는 KV Store의 인메모리 인덱스에서 요청된 키의 최신 값을 안전하게 가져옵니다.                                    |
| \[5] 응답 전송           | API Server    | 클라이언트           | 클라이언트에게 응답을 반환합니다.                                                                                                               |



### 직렬화 가능 읽기(Serializable Read)

| 단계                   | 요청 주체      | 대상 컴포넌트         | 역할 및 설명                                                                               |
| -------------------- | ---------- | --------------- | ------------------------------------------------------------------------------------- |
| \[1] 요청 수신 및 \[2] 검증 | Client     | API Server      | 클라이언트 요청(`GET` with `Serializable` 옵션)을 수신하고, Auth/Lease 컴포넌트를 통해 인증 및 권한을 확인합니다.     |
| \[3] Raft 우회 결정      | API Server | -               | 직렬화 가능 읽기 요청이므로, Raft Protocol을 통한 합의나 검증 과정을 완전히 생략합니다.                              |
| \[4] 데이터 인출          | API Server | KV Store (MVCC) | `API Server`는 KV Store의 인메모리 인덱스에서 요청된 키의 로컬 상태 값을 즉시 가져옵니다.                          |
| \[5] 응답 전송           | API Server | 클라이언트           | 클라이언트에게 응답을 반환합니다. 이 데이터는 다른 노드에 최신 Write가 이미 커밋되었더라도 해당 노드의 상태를 반영하므로 최신이 아닐 수 있습니다. |
